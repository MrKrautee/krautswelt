<div id="comment_form" class="">
    <form  method="POST">{% csrf_token %}
        {% for field in comment_form %}
        {% if field.is_hidden %}{{ field }} {% else %}
        <div class="form-group has-feedback">
            {{ field }}
            <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
            <div id="{{ field.name }}_help" class="help-block text-muted">
                {{ field.help_text }}
            </div>
            <div id="{{ field.name }}_errors" class="help-block form-errors">
                {{ field.errors }}
            </div>
        </div>{% endif %}{% endfor %}
        <div class="form-group">
            <button type="submit" id="comment_submit" class="btn btn-default">submit</button>
        </div>
    </form>
    </form>
</div>
<div id="comment_form_captcha" style="display:none;" class="container">
    <form  method="POST" class="form-horizontal">{% csrf_token %}
        {% for field in comment_form_captcha %}
        {% if field.is_hidden %}{{ field }} {% else %}
        
            {{ field }}
            
        {% endif %}{% endfor %}
        <div class="form-group">
            <button type="submit" id="comment_submit" class="btn btn-default">submit</button>
        </div>
    </form>
</div>
<script>
$( document ).ready(function() {
    var form_selector = "div#comment_form form";
    $(form_selector+" input#id_name").attr('placeholder', 'name *');
    $(form_selector+" div#name_help").html('Your name will be published.');
    $(form_selector+" input#id_email").attr('placeholder', 'e-mail *');
    $(form_selector+" div#email_help").html('Your email will never shown to anyone else.');
    $(form_selector+" input#id_website").attr('placeholder', 'http://website');
    $(form_selector+" textarea#id_comment").attr('placeholder', 'your comment ... *');
    $(form_selector+" textarea#id_comment").attr('rows', '3');
    $("div#comment_form_captcha form input#id_captcha_1").prop('required',true);
    $("div#comment_form_captcha form input#id_captcha_1").addClass('form-control');
    $("div#comment_form_captcha form img.captcha").addClass('thumbnail');
    $("div#comment_form_captcha form input#id_captcha_1").attr('placeholder', 'captcha *');
    $("div#comment_form_captcha form div#id_captcha_help").html('please enter the chars from the image.');
    $(form_selector+" :input").each(function(){
        if($(this).attr("type") != "submit" && $(this).attr("type") != "hidden"){
            $(this).addClass("form-control");
        }
    });
    /**
     * collect form data
     */
    function getFormData(){
        // collect data
        var parent = $(form_selector+' input#id_parent').val();
        var name = $(form_selector+' input#id_name').val();
        var email = $(form_selector+' input#id_email').val();
        var website = $(form_selector+' input#id_website').val();
        var comment = $(form_selector+" textarea#id_comment").val();
        var csrftoken = getCookie('csrftoken');
        var data = {
            name: name,
            email: email,
            comment: comment,
            website: website,
            parent: parent,
            csrfmiddlewaretoken: csrftoken,
        }
        return data;
    }
    
    function onSuccess(){
        $('div#comment_form').fadeOut();
        $('div#comment_form_captcha').fadeIn();
    }
    
    function getCaptchaFromData(){
        var data = getFormData();
        data.captcha_0 =  $("div#comment_form_captcha form input#id_captcha_0").val();
        data.captcha_1 =  $("div#comment_form_captcha form input#id_captcha_1").val();
        return data;
    }
    function onSuccessCaptcha(){
        $('div#comments .alert').fadeIn('slow');
        $('div#comments div#comment_form_panel').fadeOut('slow');

    }
    function onErrorCaptcha(element_name, json_response){
        $("div#comment_form_captcha form img.captcha").attr('src', json_response.url);
        $("div#comment_form_captcha form input#id_captcha_1").val('');
        $("div#comment_form_captcha form input#id_captcha_1").next('span.glyphicon').addClass('glyphicon-warning-sign');
        $("div#comment_form_captcha form input#id_captcha_1").parent().addClass('has-warning');
        $("div#comment_form_captcha form input#id_captcha_1").attr('placeholder', 'please try again.');
        $("div#comment_form_captcha form input#id_captcha_1").focus();
        var captcha_help = $("div#comment_form_captcha form div#id_captcha_help").html();
        $("div#comment_form_captcha form div#id_captcha_help").html('captcha reloaded.');
        $("div#comment_form_captcha form input#id_captcha_0").attr('value', json_response.key);

        
    }
    makeAjaxValidationForm(form_selector, "/blog/comment/form/check/", getFormData, onSuccess, true);
    makeAjaxValidationForm("div#comment_form_captcha form", "/blog/comment/form/check/", getCaptchaFromData, onSuccessCaptcha, false, onErrorCaptcha);
});
</script>
